<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>محاكاة متابعة جهاز — oppo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body{font-family:Arial, Helvetica, sans-serif; margin:0; padding:0; direction:rtl; background:#fafafa; color:#111}
  .hdr{padding:10px;background:#1976d2;color:#fff;text-align:center;font-weight:bold}
  #map{height:62vh;width:100%}
  #timeline{background:#fff;padding:12px;border-top:1px solid #ddd;max-height:36vh;overflow:auto}
  .point{padding:6px;border-bottom:1px solid #eee}
  .point.current{background:#e3f2fd}
  .controls{display:flex;gap:8px;padding:8px;align-items:center;flex-wrap:wrap;background:#fff;border-bottom:1px solid #eee}
  button,input{padding:8px;border-radius:6px;border:1px solid #ccc;cursor:pointer}
  .warn{background:#fffbe6;color:#000;padding:10px;margin:8px;border-radius:8px;border:1px solid #ffd580}
  .watermark{position:fixed;left:8px;bottom:8px;transform:rotate(-18deg);
            font-size:16px;color:rgba(255,0,0,0.12);font-weight:800;pointer-events:none;z-index:9999}
</style>
</head>
<body>

<div class="hdr">📍 محاكاة متابعة جهاز — <strong>oppo</strong></div>

<div class="warn">
  <strong>تنبيه هام:</strong> هذه صفحة مُحاكاة/تجريبية. لا تستخدمها لتضليل أو لتتبّع أشخاص حقيقيين دون إذن.
</div>

<div class="controls">
  <button id="play">تشغيل</button>
  <button id="pause">إيقاف</button>
  <button id="reset">إعادة</button>
  <label>سرعة (ms): <input id="interval" type="number" value="1400" style="width:90px" /></label>
  <label>نصف قطر حول كل نقطة (كم): <input id="radius" type="number" value="1.2" style="width:90px" /></label>
  <label><input id="loop" type="checkbox" /> تكرار المسار بعد الانتهاء</label>
  <button id="download">تحميل JSON</button>
</div>

<div id="map"></div>
<div id="timeline"></div>

<div class="watermark">مُحاكى — SIMULATION</div>

<script>
// اسم الجهاز
const deviceLabel = "oppo";

// ترتيب القرى/النقاط بعد التعديل مع مسجد القنادلة
const orderedVillages = [
  {name:"الغنايم", lat:26.8650, lon:31.3270},
  {name:"صدفا",    lat:26.7800, lon:31.6000},
  {name:"العامري", lat:26.9200, lon:31.3400},
  {name:"مسجد القنادلة", lat:26.9210, lon:31.3420},
  {name:"طما",     lat:26.7690, lon:31.4170},
  {name:"خليه سوهاج", lat:26.9170, lon:31.4330}
];

// عناصر DOM
const mapDiv = document.getElementById('map');
const timelineDiv = document.getElementById('timeline');
const playBtn = document.getElementById('play');
const pauseBtn = document.getElementById('pause');
const resetBtn = document.getElementById('reset');
const intervalInput = document.getElementById('interval');
const radiusInput = document.getElementById('radius');
const loopCheckbox = document.getElementById('loop');
const downloadBtn = document.getElementById('download');

// إعداد الخريطة
let map = L.map('map').setView([26.88,31.35], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

let marker = L.marker([orderedVillages[0].lat, orderedVillages[0].lon]).addTo(map);
let polyline = L.polyline([], {color:'red'}).addTo(map);

let simulatedPoints = [];
let simIndex = 0;
let animTimer = null;

// إحداثيات عشوائية حول النقطة
function randomNear(v, maxRadiusKm){
  const r = Math.random() * maxRadiusKm;
  const theta = Math.random() * 2 * Math.PI;
  const dx = r * Math.cos(theta);
  const dy = r * Math.sin(theta);
  const dLat = dy / 111.32;
  const dLon = dx / (111.32 * Math.cos(v.lat * Math.PI/180));
  return { lat: v.lat + dLat, lon: v.lon + dLon, village: v.name };
}

// بناء مسار مرتب
function buildOrderedPath(stepHours=12, radiusKm=1.2){
  simulatedPoints = [];
  const totalHours = 7*24;
  const steps = Math.ceil(totalHours / stepHours);
  let now = new Date();
  for(let i=0;i<steps;i++){
    const when = new Date(now.getTime() + i * stepHours * 3600 * 1000);
    const village = orderedVillages[i % orderedVillages.length];
    const p = randomNear(village, radiusKm);
    simulatedPoints.push({lat:p.lat, lon:p.lon, when, village:p.village});
  }
}

// عرض السجل
function renderTimeline(){
  timelineDiv.innerHTML = '<h4>📜 سجل المتابعة</h4>';
  simulatedPoints.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className = 'point' + (i===simIndex ? ' current' : '');
    div.innerHTML = `<strong>${p.village}</strong> — ${p.when.toLocaleString('ar-EG',{hour12:false})}
      <div style="color:#555;font-size:13px">إحداثيات: ${p.lat.toFixed(5)}, ${p.lon.toFixed(5)} — جهاز: <b>${deviceLabel}</b></div>`;
    timelineDiv.appendChild(div);
  });
  const elems = timelineDiv.querySelectorAll('.point');
  if(elems[simIndex]) elems[simIndex].scrollIntoView({behavior:'smooth', block:'center'});
}

// إعداد الخريطة والمسار
function renderMap(){
  polyline.setLatLngs([]);
  simulatedPoints.forEach(p => {
    L.circleMarker([p.lat, p.lon], {radius:4, color:'#555'}).addTo(map);
  });
  const latlngs = simulatedPoints.map(p=>[p.lat,p.lon]);
  polyline.setLatLngs(latlngs);
  if(latlngs.length){
    marker.setLatLng(latlngs[0]);
    map.fitBounds(latlngs.length===1?[[latlngs[0][0]-0.01,latlngs[0][1]-0.01],[latlngs[0][0]+0.01,latlngs[0][1]+0.01]]: polyline.getBounds().pad(0.2));
  }
}

// تشغيل الحركة
function startAnimation(){
  if(animTimer) return;
  const intervalMs = parseInt(intervalInput.value,10) || 1400;
  animTimer = setInterval(()=>{
    if(simIndex < simulatedPoints.length - 1){
      simIndex++;
      const p = simulatedPoints[simIndex];
      marker.setLatLng([p.lat,p.lon])
            .bindPopup(`<b>${p.village}</b><br>${p.when.toLocaleString('ar-EG',{hour12:false})}<br>جهاز: <strong>${deviceLabel}</strong>`);
      polyline.addLatLng([p.lat,p.lon]);
      renderTimeline();
      map.panTo([p.lat,p.lon]);
    } else {
      clearInterval(animTimer);
      animTimer = null;
      if(loopCheckbox.checked){
        simIndex = 0;
        marker.setLatLng([simulatedPoints[0].lat, simulatedPoints[0].lon]);
        polyline.setLatLngs([[simulatedPoints[0].lat, simulatedPoints[0
