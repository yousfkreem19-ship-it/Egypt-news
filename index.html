<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù…Ø­Ø§ÙƒØ§Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø¬Ù‡Ø§Ø² â€” oppo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body{font-family:Arial, Helvetica, sans-serif; margin:0; padding:0; direction:rtl; background:#fafafa; color:#111}
  .hdr{padding:10px;background:#1976d2;color:#fff;text-align:center;font-weight:bold}
  #map{height:62vh;width:100%}
  #timeline{background:#fff;padding:12px;border-top:1px solid #ddd;max-height:36vh;overflow:auto}
  .point{padding:6px;border-bottom:1px solid #eee}
  .point.current{background:#e3f2fd}
  .controls{display:flex;gap:8px;padding:8px;align-items:center;flex-wrap:wrap;background:#fff;border-bottom:1px solid #eee}
  button,input{padding:8px;border-radius:6px;border:1px solid #ccc;cursor:pointer}
  .warn{background:#fffbe6;color:#000;padding:10px;margin:8px;border-radius:8px;border:1px solid #ffd580}
  .watermark{position:fixed;left:8px;bottom:8px;transform:rotate(-18deg);
            font-size:16px;color:rgba(255,0,0,0.12);font-weight:800;pointer-events:none;z-index:9999}
</style>
</head>
<body>

<div class="hdr">ğŸ“ Ù…Ø­Ø§ÙƒØ§Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø¬Ù‡Ø§Ø² â€” <strong>oppo</strong></div>

<div class="warn">
  <strong>ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…:</strong> Ù‡Ø°Ù‡ ØµÙØ­Ø© Ù…ÙØ­Ø§ÙƒØ§Ø©/ØªØ¬Ø±ÙŠØ¨ÙŠØ©. Ù„Ø§ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„ØªØ¶Ù„ÙŠÙ„ Ø£Ùˆ Ù„ØªØªØ¨Ù‘Ø¹ Ø£Ø´Ø®Ø§Øµ Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ† Ø¯ÙˆÙ† Ø¥Ø°Ù†.
</div>

<div class="controls">
  <button id="play">ØªØ´ØºÙŠÙ„</button>
  <button id="pause">Ø¥ÙŠÙ‚Ø§Ù</button>
  <button id="reset">Ø¥Ø¹Ø§Ø¯Ø©</button>
  <label>Ø³Ø±Ø¹Ø© (ms): <input id="interval" type="number" value="1400" style="width:90px" /></label>
  <label>Ù†ØµÙ Ù‚Ø·Ø± Ø­ÙˆÙ„ ÙƒÙ„ Ù†Ù‚Ø·Ø© (ÙƒÙ…): <input id="radius" type="number" value="1.2" style="width:90px" /></label>
  <label><input id="loop" type="checkbox" /> ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
  <button id="download">ØªØ­Ù…ÙŠÙ„ JSON</button>
</div>

<div id="map"></div>
<div id="timeline"></div>

<div class="watermark">Ù…ÙØ­Ø§ÙƒÙ‰ â€” SIMULATION</div>

<script>
// Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²
const deviceLabel = "oppo";

// ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚Ø±Ù‰/Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹ Ù…Ø³Ø¬Ø¯ Ø§Ù„Ù‚Ù†Ø§Ø¯Ù„Ø©
const orderedVillages = [
  {name:"Ø§Ù„ØºÙ†Ø§ÙŠÙ…", lat:26.8650, lon:31.3270},
  {name:"ØµØ¯ÙØ§",    lat:26.7800, lon:31.6000},
  {name:"Ø§Ù„Ø¹Ø§Ù…Ø±ÙŠ", lat:26.9200, lon:31.3400},
  {name:"Ù…Ø³Ø¬Ø¯ Ø§Ù„Ù‚Ù†Ø§Ø¯Ù„Ø©", lat:26.9210, lon:31.3420},
  {name:"Ø·Ù…Ø§",     lat:26.7690, lon:31.4170},
  {name:"Ø®Ù„ÙŠÙ‡ Ø³ÙˆÙ‡Ø§Ø¬", lat:26.9170, lon:31.4330}
];

// Ø¹Ù†Ø§ØµØ± DOM
const mapDiv = document.getElementById('map');
const timelineDiv = document.getElementById('timeline');
const playBtn = document.getElementById('play');
const pauseBtn = document.getElementById('pause');
const resetBtn = document.getElementById('reset');
const intervalInput = document.getElementById('interval');
const radiusInput = document.getElementById('radius');
const loopCheckbox = document.getElementById('loop');
const downloadBtn = document.getElementById('download');

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let map = L.map('map').setView([26.88,31.35], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let marker = L.marker([orderedVillages[0].lat, orderedVillages[0].lon]).addTo(map);
let polyline = L.polyline([], {color:'red'}).addTo(map);

let simulatedPoints = [];
let simIndex = 0;
let animTimer = null;

// Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø·Ø©
function randomNear(v, maxRadiusKm){
  const r = Math.random() * maxRadiusKm;
  const theta = Math.random() * 2 * Math.PI;
  const dx = r * Math.cos(theta);
  const dy = r * Math.sin(theta);
  const dLat = dy / 111.32;
  const dLon = dx / (111.32 * Math.cos(v.lat * Math.PI/180));
  return { lat: v.lat + dLat, lon: v.lon + dLon, village: v.name };
}

// Ø¨Ù†Ø§Ø¡ Ù…Ø³Ø§Ø± Ù…Ø±ØªØ¨
function buildOrderedPath(stepHours=12, radiusKm=1.2){
  simulatedPoints = [];
  const totalHours = 7*24;
  const steps = Math.ceil(totalHours / stepHours);
  let now = new Date();
  for(let i=0;i<steps;i++){
    const when = new Date(now.getTime() + i * stepHours * 3600 * 1000);
    const village = orderedVillages[i % orderedVillages.length];
    const p = randomNear(village, radiusKm);
    simulatedPoints.push({lat:p.lat, lon:p.lon, when, village:p.village});
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„
function renderTimeline(){
  timelineDiv.innerHTML = '<h4>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h4>';
  simulatedPoints.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className = 'point' + (i===simIndex ? ' current' : '');
    div.innerHTML = `<strong>${p.village}</strong> â€” ${p.when.toLocaleString('ar-EG',{hour12:false})}
      <div style="color:#555;font-size:13px">Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${p.lat.toFixed(5)}, ${p.lon.toFixed(5)} â€” Ø¬Ù‡Ø§Ø²: <b>${deviceLabel}</b></div>`;
    timelineDiv.appendChild(div);
  });
  const elems = timelineDiv.querySelectorAll('.point');
  if(elems[simIndex]) elems[simIndex].scrollIntoView({behavior:'smooth', block:'center'});
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø±
function renderMap(){
  polyline.setLatLngs([]);
  simulatedPoints.forEach(p => {
    L.circleMarker([p.lat, p.lon], {radius:4, color:'#555'}).addTo(map);
  });
  const latlngs = simulatedPoints.map(p=>[p.lat,p.lon]);
  polyline.setLatLngs(latlngs);
  if(latlngs.length){
    marker.setLatLng(latlngs[0]);
    map.fitBounds(latlngs.length===1?[[latlngs[0][0]-0.01,latlngs[0][1]-0.01],[latlngs[0][0]+0.01,latlngs[0][1]+0.01]]: polyline.getBounds().pad(0.2));
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©
function startAnimation(){
  if(animTimer) return;
  const intervalMs = parseInt(intervalInput.value,10) || 1400;
  animTimer = setInterval(()=>{
    if(simIndex < simulatedPoints.length - 1){
      simIndex++;
      const p = simulatedPoints[simIndex];
      marker.setLatLng([p.lat,p.lon])
            .bindPopup(`<b>${p.village}</b><br>${p.when.toLocaleString('ar-EG',{hour12:false})}<br>Ø¬Ù‡Ø§Ø²: <strong>${deviceLabel}</strong>`);
      polyline.addLatLng([p.lat,p.lon]);
      renderTimeline();
      map.panTo([p.lat,p.lon]);
    } else {
      clearInterval(animTimer);
      animTimer = null;
      if(loopCheckbox.checked){
        simIndex = 0;
        marker.setLatLng([simulatedPoints[0].lat, simulatedPoints[0].lon]);
        polyline.setLatLngs([[simulatedPoints[0].lat, simulatedPoints[0
